services:
  data-ingestion:
    build: ./ML/data-ingestion
    image: agriguard-data-ingestion:1.0.0
    environment:
      - GCS_BUCKET=agriguard-ac215-data
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/agriguard-dev.json
    volumes:
      - ./ML/data-ingestion/src:/app/src
      - ./ML/data-ingestion/configs:/app/configs
      - ./data:/app/data
      - ./secrets:/app/secrets:ro
    command: python src/download_yield_data.py --sample --verbose

  data-preprocessing:                
    build: ./ML/data-preprocessing
    image: agriguard-data-preprocessing:1.0.0
    volumes:
      - ./ML/data-prepocessing/src:/app/src
      - ./data:/app/data
    command: python src/preprocess.py

  model-stress-detection:
    build: ./ML/model-stress-detection
    image: agriguard-stress:1.0.0
    volumes:
      - ./ML/model-stress-detection/src:/app/src
      - ./data:/app/data
    command: >
      python src/train_stress.py
      --save /app/data/models/stress
      --write-summaries /app/data/summaries
      --write-drivers /app/data/drivers

  model-yield-forecasting:          
    build: ./ML/model-yield-forecasting
    image: agriguard-yield:1.0.0
    volumes:
      - ./ML/model-yield-forcasting/src:/app/src
      - ./data:/app/data
    command: python src/train_yield.py --save /app/data/models/yield

  api:
    build: ./ML/api
    image: agriguard-api:0.1.0
    ports: ["8000:8000"]
    environment:
      - GCS_BUCKET=agriguard-ac215-data
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/agriguard-dev.json
    volumes:
      - ./data:/app/data
      - ./secrets:/app/secrets:ro
    depends_on: ["model-stress-detection","model-yield-forecasting"]

  workflow:
    build: ./ML/workflow
    image: agriguard-workflow:0.1.0
    volumes:
      - ./:/repo
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/app/data
      - ./secrets:/app/secrets:ro
    working_dir: /repo
